name: C/C++ CI

on: [push, pull_request, workflow_dispatch]

# on:
#   push:
#     branches: [ master ]
#   pull_request:
#     branches: [ master ]

jobs:
  configure:
    runs-on: [self-hosted, deepr]

    steps:
    - name: Check out repository code
      uses: actions/checkout@v2

    - name: configure
      run: |
        echo "üçè This job's status is ${{ job.status }}."
        Set CONAN_REVISIONS_ENABLED=1
        conan remote add common https://deepranalytics.jfrog.io/artifactory/api/conan/deepr-common
        conan user -p ${{ secrets.CONAN_PASSWORD }} -r common ${{ secrets.CONAN_USERNAME }}

  build:
    runs-on: [self-hosted, deepr]
    needs: configure
    steps:
    - name: Build
      run: |
        echo "üçè Building"
        ./ci/windows-build.bat

  create-installer:
    runs-on: [self-hosted, deepr]
    needs: build
    steps:
    - name: Create Installer
      run: |
        echo "üçè Create Installer"
        ./ci/windows-package.bat

  deploy:
    runs-on: [self-hosted, deepr]
    needs: create-installer
    steps:
      - name: Upload Installer
        uses: actions/upload-artifact@v2
        with:
          name: Installer
          path: |
            bin/Release/Scanner-*.exe
            Scanner.pdb
